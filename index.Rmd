---
title: "University of Bristol OpenSAFELY Best Practice"
author: Tom Palmer, Elsie Horne, Venexia Walker
output:
  html_document:
    # toc: true
    # toc_float:
    #   collapsed: false
    #   smooth_scroll: false
    # toc_depth: 2
    # code_download: true
    # code_folding: show
    anchor_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Introduction 

The following is intended as a set of tips for users of the OpenSAFELY system at the University of Bristol.

## Best practice guide{.tabset .tabset-pills .tabset-fade} 

### Study definition

#### Reproducibile dummy data

- To ensure the dummy data system generates exactly the same data every time you run it, set a random number generator seed at the top of the `study_definition.py` file

    ``` python
    import numpy as np
    np.random.seed(123456)
    ```

#### File formats

- Use `.feather` files for outputs from the cohortextractor, so specify an action in your `project.yaml` as follows

    ``` yaml
    generate_study_population:
      run: cohortextractor:latest generate_cohort --study-definition study_definition --output-format feather
     needs: 
      - design
      outputs:
        highly_sensitive:
          cohort: output/input.feather
    ```  
- Use the **arrow** package to read `.feather` files into R 
  
    ``` r
    library(arrow)
    read_feather(file = "myfile.feather")
    ```  
  - The `col_select` argument can be used to read in just the columns you need   

- Start each project with a preprocessing action that formats `.feather` files and outputs `.rds` files
  
    ``` r
    saveRDS(object, file = "mydata.rds")
    ```  

### R code

#### File formats

- As per the study definition best practice, outputs from the cohortextractor should be provided as `.rds` files

- Use the **readr** package to read `.rds` files 

    ``` r
    library(readr)
    read_rds(file = "mydata.rds")
    ```  
    
<!--
  - Alternatively, use the **vroom** package, the `vroom::vroom()` function has the `col_sel` argument
-->

- Use base R to save `.rds` files

    ``` r
    saveRDS(object, file = "mydata.rds")
    ```  
    
- All `.rds` files should all be classified as `highly_sensitive` in actions

#### Supported packages

- The R packages (and their version number) which are installed in the OpenSAFELY R Docker container are listed [here](https://github.com/opensafely-core/r-docker/blob/master/packages.csv)
- To request a new package, which should be on CRAN, open a new issue [here](https://github.com/opensafely-core/r-docker/issues), including the link to its CRAN webpage

#### RStudio project

- Define your repo as an RStudio project in RStudio as follows
  - File | New Project...  
    ```{r}
    knitr::include_graphics("img/rstudio-newproject-1.png")
    ```  
  - Existing Directory  
    ```{r}
    knitr::include_graphics("img/rstudio-newproject-2.png")
    ```  
  - Then find your repo
  - This will create a `.Rproj` file at the top level of your repo
  - Commit the file into your repo
  - Now you can double click the `.Rproj` file to open the repo in RStudio, so you can work on your R scripts more conveniently

### Outputs for release

All outputs should be classified as 'moderately_sensitive' in actions. OpenSAFELY does not permit information relating to less than 5 individuals to be released. Redaction functions are available from other users to help you prepare your output.

#### Tables

  - Use base R to save `.csv` files that will be sent to output checkers

    ``` r
    write.csv(object, file = "mydata.csv")
    ```  
    
#### Figures

- Use `.svg` for figure outputs that will be sent to output checkers
- Where applicable (e.g., histograms), start x-axis at 5 instead of 0 to ensure low counts are not exported

#### Releasing output

- To release an output, please complete the 'Output files for review' section of [this form](https://docs.opensafely.org/documents/OpenSAFELY_Output_Review_Form_15_11_21.docx) and email to your assigned Bristol L4 access person
- Bristol L4 access people will check the output on the server on your behalf, complete the rest of the form (including files locations), and email to datarelease@opensafely.org for final approval

<!--
### Jupyter and Rmd notebooks

- If you use a Jupyter notebook create a folder called `notebooks` at the top level of your repo
  - Only use Python code chunks within the notebook
  - The action to compile the notebook will be of the form

    ``` yaml
      generate_notebook:
        run: jupyter:latest jupyter nbconvert /workspace/analysis/report.ipynb --execute --to html --template basic --output-dir=/workspace/output --ExecutePreprocessor.timeout=86400 --no-input
        needs:
        outputs:
          moderately_sensitive:
            notebook: output/report.html
    ```

- If you use an R Markdown notebook within your repo create a folder called `rmarkdown` at the top level of the repo
  - In the YAML header of the .Rmd file define the output type as `output: html_document`
  - Write a separate .R script that runs a single command 
  
    ``` r
    rmarkdown::render('myrmdfile.Rmd', encoding = 'UTF-8') 
    ```  
  - And write an `r` action to run the script which will produce the .html output file
-->

### Miscellaneous

- Text files should end with a newline character (i.e., a blank line)
  - If you see the following red icon at the end of a file on GitHub, simply press <kbd>`r knitr::asis_output('\U21B5')` Enter</kbd> at the end of the file (i.e., in this case after the `Catalog`), resave, commit, and the red icon should be gone  
    ```{r}
    knitr::include_graphics("img/endoffile-newline-missing.png")
    ```  


